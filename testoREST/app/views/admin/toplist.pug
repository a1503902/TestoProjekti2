extends ../layouts/admin.pug

block content
  h1.ui.dividing.header= title

  table.ui.table#list-table
    thead
      tr
        th #
        th Työntekijä
        th Monta päivää töissä
        th Teho
    tbody
      tr
        td(colspan="4") Ei työntekijöitä.

block scripts
  script.
    function loadList(){
      $.ajax({
        url: "http://localhost:8080/api/workdays",
        method: "GET",
        type: "JSON",
          success: function(response){
            if(!!response.success && response.success == true){
              if(response.data.length > 0){
                $("#list-table tbody").html("");
                for(var i = 0; i < response.data.length; i++){
                  var data = response.data[i];
                  var row = $('<tr />');
                  console.log(data);
                  listByEff("DATA:A:A:A::A::"+data);
                  $("#list-table tbody").append(row);
                  if(data.complete == true){
                    row.append('<td>' + 'Sijoitus') + '</td>';
                    row.append('<td>' + setDefaultVal(data.employee, '-') + '</td>');
                    row.append('<td>' + '-' + '</td>');
                    row.append('<td>' + calcEff(data).toFixed(2) + '</td>');

                  }
                }
              }
            }else{
              alert("Failed to load data: " + data.message);
            }
          },
          error: function(err){
            alert("Failed to load data: " + JSON.stringify(err));
          }
      });
    }

    $(function(){
      loadList();
    });

    function setDefaultVal(value, defaultValue){
      return (value === undefined) ? defaultValue : (value == null) ? defaultValue : value;
    }

    function calcEff(data) {
        var pD = data.deliveries.postnord.delivery;
        var pP = data.deliveries.postnord.pickup;
        var pU = data.deliveries.postnord.unknown;
        var pNt = data.deliveries.postnord.nt;
        var bD = data.deliveries.bring.delivery;
        var bP = data.deliveries.bring.pickup;
        var bDhl = data.deliveries.bring.unknown;
        var bNt = data.deliveries.bring.nt;
        var time = (data.stop_time - data.start_time) - data.breaks;
        var ifNull = [pD, pP, pU, pNt, bD, bP, bDhl, bNt];
        var sum;
        for (var i = 0; i < ifNull.length; i++) {
            if (ifNull[i] == null) {
                ifNull[i] = 0;
            }
            if (!ifNull[0]) {
                sum = ifNull[i] + ifNull[i - 1];
            } else {
                sum = ifNull[0];
            }
        }

        var efficiency = sum / time;
        return efficiency;
    }

    var toplist = [];
    function listByEff(data) {
        console.log("DATA: "+data.name);
        var empl = {
            name : data.name,
            efficiency : calcEff(data)
        }
        toplist.push(empl);

        console.log("TOPLIST: "+toplist);

        return toplist;
    }
